"use strict";(self.webpackChunkclient=self.webpackChunkclient||[]).push([[446],{446:(e,t,a)=>{a.r(t),a.d(t,{default:()=>y});var l=a(9379),s=a(5043),i=a(8072),r=a(2018),n=a(5797),o=a(3481),c=a(828),d=a(8055),u=a(9722),m=a(1045),p=a(3003),h=a(3488),f=a(3740),x=a(579);const y=()=>{const[e,t]=(0,s.useState)([]),[a,y]=(0,s.useState)(!1),[v,g]=(0,s.useState)(null),[w,j]=(0,s.useState)(""),[_,S]=(0,s.useState)(null),[A,N]=(0,s.useState)({}),[E,b]=(0,s.useState)(null),{token:C}=(0,p.d4)((e=>e.token)),{user:k}=(0,p.d4)((e=>e.token)),T=(0,s.useRef)(null),{bookId:P}=(0,m.g)(),R=(0,m.Zp)(),z=(0,h.z)().API_URL,[O,F]=(0,s.useState)(!1),[U,B]=(0,s.useState)(!1);(0,s.useEffect)((()=>{(async()=>{B(!0);try{(async()=>{try{const e=await u.A.get("".concat(z,"api/book/").concat(P),{headers:{Authorization:"Bearer ".concat(C)}});b(e.data)}catch(e){400===e.status&&(null===T||void 0===T||T.current.show({severity:"error",summary:"Error",detail:"No book found",life:3e3})),console.error("error loading book:",e)}})(),L()}finally{B(!1)}})()}),[]);const L=async()=>{B(!0);try{const e=(await u.A.get("".concat(z,"api/title/getTitlesByBook/").concat(P),{headers:{Authorization:"Bearer ".concat(C)}})).data,a={};for(const t of e){const e=await u.A.get("".concat(z,"api/file/title/").concat(t._id),{headers:{Authorization:"Bearer ".concat(C)}});a[t._id]=e.data}N(a);const l=e.map((e=>({label:(0,x.jsxs)("div",{className:"flex justify-between align-items-center w-full",children:[(0,x.jsx)("span",{children:e.name}),"Admin"===(null===k||void 0===k?void 0:k.roles)&&(0,x.jsx)(x.Fragment,{children:(0,x.jsx)(r.$,{icon:"pi pi-plus",rounded:!0,text:!0,size:"small",onClick:t=>{$(""),t.stopPropagation(),g(e._id),y(!0)}})})]}),items:(a[e._id]||[]).map((t=>({label:(0,x.jsxs)("div",{className:"flex justify-between align-items-center w-full gap-2",children:[(0,x.jsx)("span",{style:{flexGrow:1,minWidth:0,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",display:"block"},title:t.name,children:t.name.length>30?t.name.slice(0,30)+"...":t.name}),(0,x.jsxs)("span",{className:"flex gap-2",children:[(0,x.jsx)(r.$,{icon:"pi pi-eye",rounded:!0,text:!0,size:"small",onClick:e=>{e.stopPropagation(),R("/fileview/".concat(t._id))}}),(0,x.jsx)(r.$,{icon:"pi pi-download",rounded:!0,text:!0,size:"small",onClick:e=>{e.stopPropagation(),window.open("".concat(z,"api/file/download/").concat(t._id,"?name=").concat(t.customName||t.name),"_blank")}}),"Admin"===(null===k||void 0===k?void 0:k.roles)&&(0,x.jsx)(x.Fragment,{children:(0,x.jsx)(r.$,{icon:"pi pi-trash",rounded:!0,text:!0,size:"small",severity:"danger",onClick:a=>{a.stopPropagation(),W(t._id,e._id)}})})]})]})})))})));t(l)}catch(a){var e;console.error(a),null===(e=T.current)||void 0===e||e.show({severity:"error",summary:"Error",detail:"Error loading",life:3e3})}finally{B(!1)}},W=async(e,t)=>{try{var a;await u.A.delete("".concat(z,"api/file/").concat(e),{headers:{Authorization:"Bearer ".concat(C)}}),N((a=>(0,l.A)((0,l.A)({},a),{},{[t]:a[t].filter((t=>t._id!==e))}))),L(),null===(a=T.current)||void 0===a||a.show({severity:"success",summary:"Deleted",detail:"File deleted successfuly",life:2e3})}catch(i){var s;console.error(i),null===(s=T.current)||void 0===s||s.show({severity:"error",summary:"Error",detail:"Error deleting",life:3e3})}},D=async()=>{if(!_||!v)return;F(!0);const e=await(async e=>{try{const t=await u.A.post("".concat(z,"api/file/presign"),{fileName:e.name,fileType:e.type},{headers:{Authorization:"Bearer ".concat(C)}}),{url:a,key:l}=t.data;return await u.A.put(a,e,{headers:{"Content-Type":e.type}}),l}catch(a){var t;return console.error("Error uploading to S3:",a),null===(t=T.current)||void 0===t||t.show({severity:"error",summary:"Error",detail:"Upload to S3 failed",life:3e3}),null}})(_);if(!e)return;const t="https://".concat({NODE_ENV:"production",PUBLIC_URL:"",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0,REACT_APP_API_URL:"https://atsbooks.onrender.com/"}.REACT_APP_S3_BUCKET,".s3.").concat({NODE_ENV:"production",PUBLIC_URL:"",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0,REACT_APP_API_URL:"https://atsbooks.onrender.com/"}.REACT_APP_AWS_REGION,".amazonaws.com/").concat(e);try{var a;await u.A.post("".concat(z,"api/file/save-metadata"),{title:v,name:_.name,customName:w,s3Key:e,url:t,size:Number((_.size/1024).toFixed(2))},{headers:{Authorization:"Bearer ".concat(C)}}),L(),y(!1),j(""),S(null),I(""),null===(a=T.current)||void 0===a||a.show({severity:"success",summary:"Uploaded",detail:"File uploaded successfully",life:2e3})}catch(s){var l;console.error("Error saving metadata:",s),null===(l=T.current)||void 0===l||l.show({severity:"error",summary:"Error",detail:"Saving file failed",life:3e3})}finally{F(!1)}},[H,I]=(0,s.useState)(""),[K,$]=(0,s.useState)("");return(0,x.jsx)("div",{className:"p-4",children:U?(0,x.jsx)("div",{className:"flex justify-content-center align-items-center",style:{height:"80vh"},children:(0,x.jsxs)("div",{className:"flex justify-center items-center gap-3 text-xl mt-6",children:[(0,x.jsx)("div",{className:"custom-spinner"}),(0,x.jsx)("span",{children:"Loading, please wait..."})]})}):(0,x.jsxs)(x.Fragment,{children:[E&&(0,x.jsx)("h2",{className:"text-center mb-4",children:E.name}),(0,x.jsxs)("div",{className:"flex flex-column md:flex-row gap-4",children:[(null===E||void 0===E?void 0:E.image)&&(0,x.jsx)("div",{className:"flex justify-content-center md:w-4",children:(0,x.jsx)("img",{src:E.image,alt:"Book",className:"border-round shadow-2",style:{maxWidth:"100%",maxHeight:"500px",objectFit:"contain"}})}),(0,x.jsx)("div",{className:"flex-grow-1",children:(0,x.jsx)(i.G,{model:e,className:"w-full md:w-30rem"})})]}),(0,x.jsx)(n.l,{header:"Upload new file",visible:a,onHide:()=>{y(!1),S(null),I("")},style:{width:"30rem",borderRadius:"8px",textAlign:"center"},className:"custom-upload-dialog",children:(0,x.jsxs)("div",{className:"flex flex-column gap-4",style:{padding:"1.5rem"},children:[(0,x.jsx)("label",{htmlFor:"fileName",className:"font-medium",style:{textAlign:"left"},children:"File name"}),(0,x.jsx)(d.S,{id:"fileName",placeholder:"Enter file name",value:w,onChange:e=>j(e.target.value),className:"p-inputtext-lg",style:{borderRadius:"6px",width:"100%"}}),K&&(0,x.jsx)("div",{style:{color:"red",marginTop:"8px"},children:K}),(0,x.jsx)(o.e,{mode:"basic",auto:!1,customUpload:!0,chooseLabel:"Choose file",uploadHandler:e=>{var t;let{files:a}=e;S(a[0]),I((null===(t=a[0])||void 0===t?void 0:t.name)||"")},className:"p-button-primary",style:{width:"100%"}}),H&&(0,x.jsxs)("div",{style:{textAlign:"left",fontSize:"0.9rem",color:"#555"},children:[(0,x.jsx)("strong",{children:"Selected file:"})," ",H]}),(0,x.jsxs)("div",{className:"flex justify-content-center gap-3",children:[(0,x.jsx)(r.$,{onClick:()=>{var e;_?D():null===(e=T.current)||void 0===e||e.show({severity:"warn",summary:"Error",detail:"Press upload below",life:3e3})},disabled:O,className:"p-button-primary",style:{width:"40%",position:"relative"},children:O?(0,x.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",width:"100%",gap:"0.5rem",marginTop:"1rem"},children:[(0,x.jsx)(f.p,{style:{width:"20px",height:"20px"},strokeWidth:"4"}),(0,x.jsx)("span",{children:"Loading"})]}):(0,x.jsx)("span",{children:"Upload"})}),(0,x.jsx)(r.$,{label:"Cancel",onClick:()=>{y(!1),S(null),I("")},className:"p-button-secondary",style:{width:"40%"}})]})]})}),(0,x.jsx)(c.y,{ref:T})]})})}}}]);
//# sourceMappingURL=446.9e5d398a.chunk.js.map